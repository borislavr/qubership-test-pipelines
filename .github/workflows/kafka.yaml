name: Reusable Kafka Tests

on:
  workflow_dispatch: {}
  workflow_call:
    inputs:
      service_branch:
        required: false
        type: string
      versions_file:
        description: 'Path to versions list file'
        type: string
        required: true
      pipeline_branch:
        description: 'Test pipeline branch name'
        type: string
        required: true
      runner_type:
        description: 'Runner type (self-hosted or ubuntu-latest)'
        type: string
        required: false
        default: 'ubuntu-latest'
    secrets:
      AWS_S3_ACCESS_KEY_ID:
        required: true
      AWS_S3_ACCESS_KEY_SECRET:
        required: true

jobs:
  prepare-versions:
    runs-on: ${{inputs.runner_type}}
    outputs:
      versions: ${{steps.process-versions.outputs.versions}}
      previous_version: ${{steps.process-versions.outputs.previous_version}}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.service_branch}}'
          repository: 'Netcracker/qubership-kafka'
          path: 'qubership-kafka'
      - name: Process versions file
        id: process-versions
        # language=bash
        run: |
          versions_str=$(cat qubership-kafka/${{inputs.versions_file}})
          versions_json=$(echo $versions_str | jq -R -s -c 'split(" ")')
          echo "versions=$versions_json" >> $GITHUB_OUTPUT
          previous_version=$(echo "$versions_json" | jq -r '.[-1]')
          echo "previous_version=$previous_version" >> $GITHUB_OUTPUT

  # ---------- Current service branch ----------
  #V Clean [LATEST], Update [LATEST] Diff Params in Kraft mode
  Clean-Latest-Update-Diff-Params-Kraft:
    runs-on: ${{inputs.runner_type}}
    name: Clean [LATEST], Update [LATEST] Diff Params in Kraft mode
    steps:
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.pipeline_branch}}'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
      #- name: Install Monitoring
        #uses: ./qubership-test-pipelines/actions/monitoring/helm_deploy_monitoring
      - name: Clean Install Kafka [LATEST]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_kraft_mode.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
      - name: Clean Install Kafka Service [LATEST]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_kraft_mode.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service
      - name: Update Kafka to [LATEST] Version With Diff Params
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_update_kraft_mode.yml'
          service_branch: '${{inputs.service_branch}}'
          deploy_mode: upgrade
      - name: Sleep 1m after update
        run: sleep 1m
      - name: Verify Kafka update
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
      - name: Update Kafka Service to [LATEST] Version With Diff Params
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_update_kraft_mode.yml'
          service_branch: '${{inputs.service_branch}}'
          deploy_mode: upgrade
      - name: Sleep 1m after update
        run: sleep 1m
      - name: Verify Kafka Service update
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service

  # ---------- Current service branch ----------
  #V Clean [LATEST] with Zookeeper in non-TLS
  Clean-Latest-Zookeeper-non-TLS:
    runs-on: ${{inputs.runner_type}}
    name: Clean [LATEST] with Zookeeper in non-TLS
    steps:
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.pipeline_branch}}'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
        #- name: Install Monitoring
        #uses: ./qubership-test-pipelines/actions/monitoring/helm_deploy_monitoring
      - name: Clean Install Zookeeper [LATEST]
        uses: ./qubership-test-pipelines/actions/zookeeper/helm_deploy_zookeeper
        with:
          path_to_template: 'templates/zookeeper-service/zookeeper_install_APP_k8s.yml'
          service_branch: 'main'
      - name: Verify Zookeeper installation
        uses: ./qubership-test-pipelines/actions/zookeeper/verify_installation_zookeeper
      - name: Clean Install Kafka [LATEST]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
      - name: Clean Install Kafka Service [LATEST]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service

  #---------- Current service branch ----------
  #V Clean [LATEST] with Zookeeper in TLS
  Clean-Latest-Zookeeper-TLS:
    runs-on: ${{inputs.runner_type}}
    name: Clean [LATEST] with Zookeeper in TLS
    steps:
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.pipeline_branch}}'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
        #- name: Install Monitoring
        #uses: ./qubership-test-pipelines/actions/monitoring/helm_deploy_monitoring
      - name: Install cert-manager
        # language=bash
        run: |
          helm repo add jetstack https://charts.jetstack.io --force-update
          helm upgrade --install cert-manager jetstack/cert-manager --namespace cert-manager \
            --create-namespace --version v1.16.3 --set prometheus.enabled=true   --set crds.enabled=true
      - name: Create cert-manager entities
        # language=bash
        run: |
          kubectl apply -f qubership-test-pipelines/resources/test-issuer.yaml
          sleep 10s
          kubectl apply -f qubership-test-pipelines/resources/test-certificate.yaml
          sleep 10s
          kubectl apply -f qubership-test-pipelines/resources/test-clusterissuer.yaml
      - name: Get cert-manager resources
        # language=bash
        run: |
          kubectl get pods -n cert-manager
          kubectl get secrets -n cert-manager
          kubectl get certificates -A
      - name: Get clusterissuer
        # language=bash
        run: |
          kubectl get clusterissuer
          kubectl get clusterissuer test-clusterissuer -o yaml
      - name: Clean Install Zookeeper [LATEST] without TLS
        uses: ./qubership-test-pipelines/actions/zookeeper/helm_deploy_zookeeper
        with:
          path_to_template: 'templates/zookeeper-service/zookeeper_install_APP_k8s.yml'
          service_branch: 'main'
      - name: Verify Zookeeper installation
        uses: ./qubership-test-pipelines/actions/zookeeper/verify_installation_zookeeper
      - name: Clean Install Kafka [LATEST] in TLS
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo_tls_false.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
      - name: Get Kafka secrets
        run: |
          kubectl get secrets -n kafka
          kubectl get secret kafka-tls-secret -n kafka -o yaml
      - name: Clean Install Kafka Service [LATEST] in TLS
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo_tls_false.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service

  #---------- Current service branch ----------
  #V Clean [LATEST] with Zookeeper when both are in TLS
  Clean-Latest-Zookeeper-both-TLS:
    runs-on: ${{inputs.runner_type}}
    name: Clean [LATEST] with Zookeeper when both in TLS
    steps:
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.pipeline_branch}}'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
        #- name: Install Monitoring
        #uses: ./qubership-test-pipelines/actions/monitoring/helm_deploy_monitoring
      - name: Install cert-manager
        # language=bash
        run: |
          helm repo add jetstack https://charts.jetstack.io --force-update
          helm upgrade --install cert-manager jetstack/cert-manager --namespace cert-manager \
            --create-namespace --version v1.16.3 --set prometheus.enabled=true   --set crds.enabled=true
      - name: Create cert-manager entities
        # language=bash
        run: |
          kubectl apply -f qubership-test-pipelines/resources/test-issuer.yaml
          sleep 10s
          kubectl apply -f qubership-test-pipelines/resources/test-certificate.yaml
          sleep 10s
          kubectl apply -f qubership-test-pipelines/resources/test-clusterissuer.yaml
      - name: Get cert-manager resources
        # language=bash
        run: |
          kubectl get pods -n cert-manager
          kubectl get secrets -n cert-manager
          kubectl get certificates -A
      - name: Get clusterissuer
        # language=bash
        run: |
          kubectl get clusterissuer
          kubectl get clusterissuer test-clusterissuer -o yaml
      - name: Clean Install Zookeeper [LATEST] in TLS
        uses: ./qubership-test-pipelines/actions/zookeeper/helm_deploy_zookeeper
        with:
          path_to_template: 'templates/zookeeper-service/zookeeper_install_tls_APP_k8s.yml'
          service_branch: 'main'
      - name: Verify Zookeeper installation
        uses: ./qubership-test-pipelines/actions/zookeeper/verify_installation_zookeeper
      - name: Get Zookeeper secrets
        run: |
          kubectl get secrets -n zookeeper
          kubectl get secret zookeeper-tls-secret -n zookeeper -o yaml
      - name: Clean Install Kafka [LATEST] in TLS
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo_tls.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
      - name: Get Kafka secrets
        run: |
          kubectl get secrets -n kafka
          kubectl get secret kafka-tls-secret -n kafka -o yaml
      - name: Clean Install Kafka Service [LATEST] in TLS
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo_tls.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service

  #V Clean [LATEST] with Zookeeper on S3
  Clean-Latest-Zookeeper-S3:
    runs-on: ${{inputs.runner_type}}
    name: Clean [LATEST] with Zookeeper on S3 storage
    steps:
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.pipeline_branch}}'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
      - name: Clean Install Zookeeper [LATEST]
        uses: ./qubership-test-pipelines/actions/zookeeper/helm_deploy_zookeeper
        with:
          path_to_template: 'templates/zookeeper-service/zookeeper_install_APP_k8s.yml'
          service_branch: 'main'
      - name: Verify Zookeeper installation
        uses: ./qubership-test-pipelines/actions/zookeeper/verify_installation_zookeeper
      - name: Update YAML secrets
        # language=bash
        run: |
          python qubership-test-pipelines/python/update_yaml.py \
            --file='qubership-test-pipelines/templates/kafka-service/kafka_clean_sc_zoo_s3.yml' \
            --path='global/secrets/backupDaemon/s3/keyId' \
            --value='${{secrets.AWS_S3_ACCESS_KEY_ID}}' \
          && python qubership-test-pipelines/python/update_yaml.py \
            --file='qubership-test-pipelines/templates/kafka-service/kafka_clean_sc_zoo_s3.yml' \
            --path='global/secrets/backupDaemon/s3/keySecret' \
            --value='${{secrets.AWS_S3_ACCESS_KEY_SECRET}}'
      - name: Clean Install Kafka [LATEST] on s3
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo_s3.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
      - name: Clean Install Kafka Service [LATEST] on s3
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo_s3.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service


  #---------- Upgrade from old releases ----------
  #Clean [N1_RELEASE], Upgrade From [N1_RELEASE] To [LATEST_SPRINT]
  #Clean [N2_RELEASE], Upgrade From [N2_RELEASE] To [LATEST_SPRINT]
  Clean-Previous-Upgrade-To-Latest:
    name: Clean [PREVIOUS], Upgrade to [LATEST]
    needs: prepare-versions
    runs-on: ${{inputs.runner_type}}
    strategy:
      matrix:
        release: ${{fromJson(needs.prepare-versions.outputs.versions)}}
    steps:
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: '${{inputs.pipeline_branch}}'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
      #- name: Install monitoring
        #uses: ./qubership-test-pipelines/actions/monitoring/helm_deploy_monitoring
      - name: Clean Install Zookeeper [LATEST]
        uses: ./qubership-test-pipelines/actions/zookeeper/helm_deploy_zookeeper
        with:
          path_to_template: 'templates/zookeeper-service/zookeeper_install_APP_k8s.yml'
          service_branch: 'main'
      - name: Verify Zookeeper installation
        uses: ./qubership-test-pipelines/actions/zookeeper/verify_installation_zookeeper
      - name: Clean Install Kafka [PREVIOUS]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo.yml'
          service_branch: '${{matrix.release}}'
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
        with:
          service_branch: '${{matrix.release}}'
      - name: Clean Install Kafka Service [PREVIOUS]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo.yml'
          service_branch: '${{matrix.release}}'
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service
        with:
          service_branch: '${{matrix.release}}'
      - name: Upgrade Kafka to [LATEST]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka
        with:
          deploy_mode: upgrade
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Sleep 1m after upgrade
        run: sleep 1m
      - name: Verify Kafka installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka
        with:
          service_branch: '${{inputs.service_branch}}'
      - name: Upgrade Kafka Service to [LATEST]
        uses: ./qubership-test-pipelines/actions/kafka/helm_deploy_kafka_service
        with:
          deploy_mode: upgrade
          path_to_template: 'templates/kafka-service/kafka_clean_sc_zoo.yml'
          service_branch: '${{inputs.service_branch}}'
      - name: Sleep 1m after upgrade
        run: sleep 1m
      - name: Verify Kafka Service installation
        uses: ./qubership-test-pipelines/actions/kafka/verify_installation_kafka_service
        with:
          service_branch: '${{inputs.service_branch}}'
